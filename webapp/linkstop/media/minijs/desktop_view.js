SIMPLE_ALPHA=!jQuery.support.opacity;NOTES_ANIM=!SIMPLE_ALPHA;icon_template='<div class="notes" id="notes-{{ icon_id }}"><div class="content">{{ notes }}</div><div class="end"></div></div><div class="icon {{ icon_id }}" id="{{ icon_id }}" style="width:{{ icon_width }}px;"><div class="inner"  name="{{ icon_id }}" title="{{ description }}"><div class="handle" name="{{ icon_id }}"style="margin:0 auto;width:{{ icon_size }}px;height:{{ icon_size }}px;"></div><div class="icon-label"><a href="{{ url }}" target="_blank">{{ name }}</a></div><div class="search-box"><input name="search-{{ icon_id }}"></div></div></div>';icon_img_template='<a href="{{ url }}" target="_blank"> <img src="{{ img_url }}" style="padding:0px;margin:0px;width:100%;height:100%;" /> </a>';desktop_label_template='<div class="desktop-label"><a href="{{ url }}" title="View this desktop">{{ name }}</a></div>';_username=null;_desktop_slug=null;fade_notes_timeout=null;function clock(){return new Date().getTime()}String.prototype.f=function(c){var b=this.toString();var a=b.replace(/{{\s*(.*?)\s*}}/g,function(d,f){var e=c;$.each(f.split("."),function(g,h){e=e[h]||""});return e});return a};function desktop_api(d,b,c){var a="/api/"+d+"/";return $.post(a,b,c,"json")}function pos_css(a,b){return{left:a,top:b}}function move_icon(b,a,c){b.$icon.css({top:c+"px",left:a+"px"})}function animate_icon(b,a,d,c){b.$icon.animate(pos_css(a,d),500,"swing",c)}icons=null;open_stack=null;function on_click(a){var b=icons[a];if(b.type=="stack"){show_stack(a);return false}hide_stack();return true}function hide_stack(){var a=icons[open_stack];if(!a){return}$.each(icons,function(b,c){if(open_stack==c.stack){c.$icon.find(".icon-label").fadeOut();animate_icon(c,a.pos.x,a.pos.y,function(){c.$icon.hide()});c.$icon.fadeOut()}});open_stack=null}function get_animate_pos(c,b){var d=c.pos;var a=Math.round(d.x);var e=Math.round(d.y);a+=c.handle_offset.x-b.handle_offset.x;e+=c.handle_offset.y-b.handle_offset.y;return{x:Math.round(a),y:Math.round(e)}}function show_stack(b){if($.timers.length){return}var a=icons[b];if(open_stack==b){$.each(icons,function(c,d){if(b==d.stack){d.$icon.find(".icon-label, .search-box").fadeOut("normal");if(!SIMPLE_ALPHA){d.$icon.find(".handle").fadeOut("normal")}var e=get_animate_pos(a,d);animate_icon(d,e.x,e.y,function(){d.$icon.hide()});if(!SIMPLE_ALPHA){d.$icon.fadeOut()}}});open_stack=null;return}$.each(icons,function(c,d){if(d.stack==b){d.$icon.find(".search-box,.icon-label").hide();var f=get_animate_pos(a,d);move_icon(d,f.x,f.y);d.$icon.show();if(!SIMPLE_ALPHA){d.$icon.find(".handle").hide().fadeIn("fast")}animate_icon(d,d.stack_pos.x,d.stack_pos.y,function(){if(!SIMPLE_ALPHA){d.$icon.find(".icon-label").fadeIn("fast")}else{d.$icon.find(".icon-label").show()}if(d.search_url){d.$icon.find(".search-box").show()}})}if(open_stack&&d.stack==open_stack){if(!SIMPLE_ALPHA){d.$icon.find(".icon-label, .search-box, .handle").fadeOut("normal");d.$icon.find(".handle").fadeOut("normal")}var e=icons[d.stack];var f=get_animate_pos(e,d);animate_icon(d,f.x,f.y,function(){d.$icon.hide()});if(!SIMPLE_ALPHA){d.$icon.fadeOut()}}});open_stack=b}got_options=false;function get_url(c){if(c.search_url){var d=c.$icon.find(".search-box input");var b=d.val();if(b){var a=c.search_url.replace("[SEARCH]",b)}else{var a=c.url}}else{var a=c.url}return a}function show_menu(a){$("#menu_"+a).toggle();return false}function render_desktop(b){if(!b){return}var f=$(".icon-layer");current_desktop=b;var e=$(window);show_notes_timer=null;hide_notes_timer=null;var a=$("input#desktop_slug");var d=$("input#username");_desktop_slug=a.val();_username=d.val();show_notes_time=null;$preloads=$("#preloads");$active_notes=null;var c={};icons={};$.each(b.icons,function(m,r){var g=r.icon_id;icons[g]=r;var k=r;var t=get_icon_sizes(r).slice();var w=t[0];for(var y=0;y<t.length;y++){if(t[y]==r.icon_size){w=t[y]}if(t[y]>r.icon_size){break}w=t[y]}k.img_url=get_img_template(r).replace(/\[SIZE\]/g,w);var x=Math.max(r.icon_size*1.5,96);k.icon_width=x;k.img_url=pathjoin([MEDIA_URL,k.img_url]);if(k.notes!==undefined){k.notes=text_to_html(k.notes)}if(c[k.img_url]===undefined){$preloads.append('<img src="{{ img_url }}"/>'.f(k));c[k.img_url]=true}var n=icon_template.f(k);f.append(n);var q=$("."+g);var o=$("#notes-"+g);r.$icon=q;r.$notes=o;q.css({left:r.pos.x,top:r.pos.y});dynamic_preload(k.img_url,function(){q.find(".handle").html(icon_img_template.f(k));q.find(".handle,.icon-label a").unbind("click").click(function(){return on_click(r.icon_id)})});var l=q.offset();var v=q.find(".handle:first").offset();var j=v.left-l.left+r.icon_size/2;var h=v.top-l.top+r.icon_size/2;r.handle_offset={x:j,y:h};if(r.type=="stack"){q.addClass("stack")}var p=Math.min(r.icon_size*0.5,32);var x=Math.max(r.icon_size+p,96);q.css({width:x});if(r.visible&&!r.stack){q.show();if(r.search_url){r.$icon.find(".search-box").show()}}$(document).mousemove(function(i){u(i.pageX,i.pageY)});q.find(".handle,.icon-label a").unbind("click").click(function(){return on_click(r.icon_id)});function u(s,B){if(!$active_notes){return}var z=$(window).width();var A=$active_notes.width();var i=10;if(s+A+i>z){$active_notes.addClass("left");s=s-A-i}else{$active_notes.removeClass("left");s+=i}B-=28;$active_notes.css({left:s+"px",top:B+"px"})}q.find(".icon-label,.handle").mousemove(function(i){u(i.pageX,i.pageY);if(r.type=="stack"&&open_stack!=r.icon_id){show_stack(r.icon_id)}if(!$active_notes){$("div.notes").not(o).hide();if(r.notes){$active_notes=o;if(false&&!SIMPLE_ALPHA){$active_notes.fadeIn("fast")}else{$active_notes.show()}}}else{if(o!==$active_notes){$("div.notes").not(o).hide();$active_notes=o;if(r.notes){o.show()}}}}).mouseout(function(i){if($active_notes){$active_notes.hide();$active_notes=null}});q.find(".search-box input").change(function(s){var i=get_url(r);q.find("a").attr("href",i)}).keyup(function(i){if(i.keyCode==13){window.open(get_url(r))}}).focus(function(i){this.selectionStart=0;this.selectionEnd=$(this).val().length;return false})});$(document).mousedown(function(g){if(g.target.tagName!="A"&&g.target.tagName!="UL"){$(".menu").fadeOut("fast");g.stopPropagation()}})}function bind(){$(".desktop-label").click(function(c){var b=$(this);var a=b.find("a:first");if(c.target.tagName=="A"){return true}if(a.attr("onclick")){b.find("a:first").click()}else{location.href=a.attr("href")}return true})}function create_desktop(){function a(b){if(b.response.result=="success"){window.location=b.response.url}else{desktop_alert("Create Desktop",b.response.message)}}popup("new-desktop",{label:"Create new desktop",callback:function(){var b=$("#new_desktop_name").val();if(!b){return false}var c=$("#private_desktop").is(":checked");desktop_api("create_desktop",{desktop_name:b,"private":c},a);return true}},true);return false}function delete_desktop(){function a(b){if(b.response.result=="success"){window.location=b.response.url}else{desktop_alert("Delete Desktop",b.response.message)}}popup("delete",{label:"Yes, delete this desktop",callback:function(){var b=$("#desktop_slug").val();var c=$("#username").val();desktop_api("delete_desktop",{username:c,desktop_slug:b},a)}},true)}function rename_desktop(){popup("rename-desktop",{label:"Rename this desktop",callback:function(){var b=$("#rename_desktop").val();var a=$("#desktop_slug").val();var c=$("#username").val();desktop_api("rename_desktop",{username:c,desktop_slug:a,new_name:b},function(d){dismiss_popup();if(d.response.result=="success"){window.location.href=d.response.url}else{desktop_alert("Rename Desktop",d.response.message)}})}},true)}function toggle_private(){function a(g){if(g.response.result!="success"){desktop_alert("Unable to change setting",g.response.message);return}if(g.response.value){desktop_alert("Desktop Setting Changed","This desktop has been made <em>private</em> (only you may view this desktop).");$(".desktop-label.active").addClass("private")}else{desktop_alert("Desktop Setting Changed","This desktop has been made <em>public</em> (anyone can view this desktop).");$(".desktop-label.active").removeClass("private")}}var b=$("#setting_private").val()=="1";var d=$("#desktop_slug").val();var f=$("#username").val();b=!b;$("#setting_private").val(b?"1":"0");var e=$("#menu_options li.desktop-setting a");if(b){e.addClass("on").removeClass("off")}else{e.addClass("off").removeClass("on")}var c={desktop_slug:d,username:f,key:"private",value:b};desktop_api("set_desktop_setting",c,a)}function make_homepage(){$(".menu").fadeOut("fast");document.body.style.behavior="url(#default#homepage)";document.body.setHomePage(window.location.href)}function on_menu_click(a){if(a=="create-desktop"){create_desktop()}if(a=="delete-desktop"){delete_desktop()}if(a=="toggle-private"){toggle_private()}if(a=="make-homepage"){make_homepage()}if(a=="rename-desktop"){rename_desktop()}}$(document).ready(function(){MEDIA_URL=$("#media_url").val();function a(){if(!desktop_initial_state){desktop_initial_state={icons:{}}}render_desktop(desktop_initial_state);var b=$("#desktop_slug").val();$("#menu_options li.disabled a").unbind("click").attr("onclick","return false;").click(function(){return false});$("#desktop-view-links").css({"z-index":3000});$("#desktoplink-"+b).addClass("active");bind()}a()});